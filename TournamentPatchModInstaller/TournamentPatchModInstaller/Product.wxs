<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="26ad8e8f-756c-4d0a-9422-07b8a800740b" Name="TournamentPatchMod" Language="1033" Version="1.6.5" Manufacturer="Tournament Patch" UpgradeCode="664efaf7-ab73-44f9-9ac1-0b98202a9ae8">
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Platform="x64"/>

    <MajorUpgrade Schedule="afterInstallValidate" DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <Icon Id="ss.ico" SourceFile="Visuals\ss.ico"/>
    <Property Id="ARPPRODUCTICON" Value="ss.ico" />

    <UIRef Id="WixUI_FeatureTree"/>
    <Property Id="WIXUI_INSTALLDIR" Value="TARGETDIR" />
    <WixVariable Id="WixUILicenseRtf" Value="Visuals\License.rtf" />

    <Property Id="DOWROOTFOLDER">
      <RegistrySearch Id="DowRootFolder"
                      Root="HKLM"
                      Key="SOFTWARE\THQ\Dawn of War - Soulstorm"
                      Name="installlocation"
                      Type="raw" />
    </Property>

    <Property Id="PREVIOUSINSTALLFOLDER">
      <RegistrySearch Id="PreviousInstallFolder"
                      Root="HKLM"
                      Key="Software\TpMod\TpMod"
                      Name="path"
                      Type="raw"/>
    </Property>


    <CustomAction Id="SetDowRootDir" Property="TARGETDIR" Value="[DOWROOTFOLDER]"/>
    <CustomAction Id="SetPreviousInstallDir" Property="TARGETDIR" Value="[PREVIOUSINSTALLFOLDER]"/>


    <InstallUISequence>
      <Custom Action="SetPreviousInstallDir" Before="SetDowRootDir"></Custom>
      <Custom Action="SetDowRootDir" Before="CostFinalize">
        PREVIOUSINSTALLFOLDER = ""
      </Custom>
    </InstallUISequence>

    <InstallExecuteSequence>

    </InstallExecuteSequence>


    <Feature Id="TpMod" Title="TournamentPatch Mod" Level="1" ConfigurableDirectory="TARGETDIR">
      <ComponentGroupRef Id="TpModComponents" />
      <ComponentGroupRef Id="Additions"/>
    </Feature>

    <Feature Id="CameraFix" Title="Camera Fix" Display="collapse">
      <ComponentGroupRef Id="CameraFix"/>
    </Feature>

    <!--32767 is max available level value, so setting it shows feature as "not to be installed" by default-->
    <Feature Id="QwertyHotkeys" Title="Set QWERTY hotkeys by default" Level="32767" Display="collapse">
      <ComponentGroupRef Id="QwertyHotkeys"/>
    </Feature>

  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir" ComponentGuidGenerationSeed="626453c8-0f6b-49da-a02d-98b638f528b5">
      <Directory Id="DesktopFolder" SourceName="Desktop"/>
      <Directory Id="TP" Name="TournamentPatch"/>
      <Directory Id="ENGINE" Name="Engine">
        <Directory Id="ENGINE_DATA" Name="Data"/>
      </Directory>
      <Directory Id="PROFILES" Name="Profiles">
        <Directory Id="PROFILES_PROFILE1" Name="Profile1">
          <Directory Id="PROFILES_PROFILE1_TOURNAMENTPATCH_PROFILE" Name="tournamentpatch"/>
        </Directory>
      </Directory>
    </Directory>
  </Fragment>


  <Fragment>
    <ComponentGroup Id="CameraFix" Directory="ENGINE_DATA">
      <Component Id="CameraFix" Guid="675abc99-ed94-4cfe-9152-928353b0cd2d">
        <File Id="CameraHigh.lua" Source="..\..\Files\CameraFix\camera_high.lua"></File>
        <File Id="CameraEd.lua" Source="..\..\Files\CameraFix\camera_ed.lua"></File>
        <File Id="CameraLow.lua" Source="..\..\Files\CameraFix\camera_low.lua"></File>
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="QwertyHotkeys" Directory="PROFILES_PROFILE1_TOURNAMENTPATCH_PROFILE">
      <Component Id="QwertyHotkeys" Guid="800663d1-0137-48b9-8731-e020d8153044">
        <File Id="KeyDefaults.lua" Source="..\..\Files\QwertyHotkeys\KEYDEFAULTS.LUA"></File>
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="Additions" Directory="TARGETDIR">
      <Component Id="RegistryEntries" Guid="821d8b0e-4895-49de-90b7-6cc98a3a47bb">
        <RegistryKey Root="HKLM"
                     Key="Software\TpMod\TpMod"
                     Action="createAndRemoveOnUninstall">
          <RegistryValue Type="string" Name="path" Value="[TARGETDIR]"/>
        </RegistryKey>
      </Component>
      <Component Id="LauncherShortcut" Guid="e1f69857-c574-48a1-bc20-701d9fe219c3">
        <Shortcut Id="SoulstormShortcut"
                  Name="Tournament Patch"
                  Target="[TARGETDIR]Soulstorm.exe"
                  Arguments="-modname TournamentPatch"
                  Directory="DesktopFolder"
                  Icon="ss.ico"/>
        <RegistryValue Root="HKCU"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"
                       Key="Software\TpMod\TpMod"/>
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>
